{% extends "base.html" %}

{% load staticfiles %}

{% block head_block %}
{{ block.super }}


<!-- Codemirror core CSS -->
    <link rel="stylesheet" href="{% static "codemirror/lib/codemirror.css" %}">
    <link rel="stylesheet" href="{% static "codemirror/addon/fold/foldgutter.css" %}" />
    <link rel="stylesheet" href="{% static "codemirror/theme/neat.css" %}">
    <link rel="stylesheet" href="{% static "codemirror/addon/dialog/dialog.css" %}">
    <link rel="stylesheet" href="{% static "codemirror/addon/display/fullscreen.css" %}">
     <link rel="stylesheet" href="{% static "css/drag_drop.css" %}">

{% endblock %}
{% block title_header_big %}
{{ block.super }}
Edit {{descriptor_type}} Descriptor
{% endblock %}


{% block left_sidebar %}
{% include 'click/click_project_left_sidebar.html' %}
{% endblock %}

{% block breadcrumb_body %}
{{ block.super }}
<li><a href="{% url 'projects:open_project' project_id=project_id %}">{{project_overview_data.name}}</a></li>
<li><a href="{% url 'projects:open_project' project_id=project_id %}descriptors/{{descriptor_type}}">
    {{descriptor_type}} Descriptors</a></li>
<li><a>{{descriptor_id}}</a></li>

{% endblock %}

{% block content_body %}
{{ block.super }}
<div class="row">
    <div class="col-md-12">
        <div class="nav-tabs-custom">
            <ul class="nav nav-tabs">
                <li class="active" id="editor_li"><a href="#editor" data-toggle="tab"><i class="fa fa-file-code-o"></i>
                    Editor</a></li>

                <li class="pull-right">
                    <button id="save" type="button" class="btn btn-block btn-primary btn-sm" onclick="update(this.id)">
                        <i class="fa fa-save"></i> Save
                    </button>
                </li>
                <li class="pull-right">
                    <button id="save_show_graph" type="button" class="btn btn-block btn-primary btn-sm"
                            onclick="update(this.id)"><i class="fa fa-save"></i> Save and Show Graph
                    </button>
                </li>
                <li class="pull-right">
                    <button type="button" class="btn btn-block btn-primary btn-sm" onclick="goToGraph()"><i
                            class="fa fa-sitemap"></i> Show Graph
                    </button>
                </li>

            </ul>
            <div class="tab-content">


                <!-- /.tab-pane -->
                <div class="active tab-pane" id="editor_tab">
			<textarea id="code_editor">
            </textarea>
                </div>
                <!-- /.tab-pane-->


                <!-- /.tab-pane -->
            </div>
            <!-- /.tab-content -->


        </div>

    </div>
</div>
{% endblock %}

{% block resource_block %}
{{ block.super }}


<script src="{% static "codemirror/lib/codemirror.js" %}"></script>
    <script src="{% static "codemirror/lib/formatting.js" %}"></script>
<script src="{% static "codemirror/addon/fold/foldcode.js" %}"></script>
    <script src="{% static "codemirror/addon/fold/foldgutter.js" %}"></script>
<script src="{% static "codemirror/addon/fold/brace-fold.js" %}"></script>
    <script src="{% static "codemirror/mode/javascript/javascript.js" %}"></script>
<script src="{% static "codemirror/mode/xml/xml.js" %}"></script>
    <script src="{% static "codemirror/mode/markdown/markdown.js" %}"></script>
<script src="{% static "codemirror/addon/search/searchcursor.js" %}"></script>
    <script src="{% static "codemirror/addon/search/search.js" %}"></script>
<script src="{% static "codemirror/addon/dialog/dialog.js" %}"></script>
    <script src="{% static "codemirror/addon/display/autorefresh.js" %}"></script>
<script src="{% static "codemirror/addon/edit/matchbrackets.js" %}"></script>
    <script src="{% static "codemirror/addon/edit/closebrackets.js" %}"></script>
<script src="{% static "codemirror/addon/display/fullscreen.js" %}"></script>
    <script src="{% static "codemirror/keymap/sublime.js" %}"></script>


<script>
var editorClick;

    var click_editor_settings = {
            mode: "text",
            showCursorWhenSelecting: true,
            autofocus: true,
            lineNumbers: true,
            lineWrapping: true,
            foldGutter: true,
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
            autoCloseBrackets: true,
            matchBrackets: true,
            extraKeys: {
                "F11": function(cm) {
                    cm.setOption("fullScreen", !cm.getOption("fullScreen"));
                },
                "Esc": function(cm) {
                    if (cm.getOption("fullScreen")) cm.setOption("fullScreen", false);
                },
                "Ctrl-Q": function(cm) {
                    cm.foldCode(cm.getCursor());
                }
            },
            theme: "neat",
            keyMap: "sublime",
        }



$(document).ready(function () {
   var myTextArea = document.getElementById("code_editor");
   editorClick = CodeMirror(function(elt) {
                    myTextArea.parentNode.replaceChild(elt, myTextArea);
                }, click_editor_settings );


   editorClick.setValue({{ descriptor_strings.descriptor_string_json |safe }});
   editorClick.setOption("autoRefresh", true);




});



function update(e){
            console.log(e);
            var id = $('.nav-tabs .active').attr('id');
            var type, text ;
            switch(id) {
                case 'yaml_li':
                    type = 'yaml';
                    text = editorYaml.getValue();
                    break;
                case 'json_li':
                    type = 'json';
                    text = editorJSON.getValue();
                    break;
                case 'form_li':
                    type = 'file'
                    return;
                    break;
            }
            $.ajax({
                    url: "/projects/{{project_id}}/descriptors/{{descriptor_type}}/{{descriptor_id}}/",
                    type: 'POST',
                    dataType: 'json',
                    data: { 'csrfmiddlewaretoken' : '{{csrf_token}}',
                            'type': type,
                            'text': text
                     },
                    success: function(result) {
                        if(e =='save'){
                            window.location.href="/projects/{{project_id}}/descriptors/{{descriptor_type}}"
                        }else{
                            goToGraph();
                        }
                    },
                    error: function(result) {
                        console.log(result)
                        alert("some error");
                    }
                });
        }

function goToGraph(){
    window.location.href='/projects/{{project_id}}/graph?type={{descriptor_type}}&id={{descriptor_id}}'
}

</script>
{% endblock %}

